{% extends "menu.html" %}

{% block title %}Informações do SEEU{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Informações do SEEU</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('seeu') }}">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="infopen" class="form-label">Infopen</label>
                <select class="form-control" id="infopen" name="infopen">
                    <option value="">Selecione um Infopen</option>
                    {% for user in users %}
                        <option value="{{ user.infopen }}" {% if request.form.infopen == user.infopen or selected_infopen == user.infopen %}selected{% endif %}>{{ user.infopen }} - {{ user.nome_completo }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label for="data_notificacao" class="form-label">Data Descumprimento Lançado no SEEU</label>
                <input type="date" class="form-control" id="data_notificacao" name="data_notificacao" value="{{ request.form.data_notificacao }}">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="numero_seeu" class="form-label">Número do SEEU</label>
                <input type="text" class="form-control" id="numero_seeu" name="numero_seeu" value="{{ request.form.numero_seeu }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="protocolo" class="form-label">Protocolo</label>
                <input type="text" class="form-control" id="protocolo" name="protocolo" value="{{ request.form.protocolo }}">
            </div>
        </div>

        <div class="mb-3">
            <label for="anotacoes" class="form-label">Anotações</label>
            <textarea class="form-control" id="anotacoes" name="anotacoes" rows="4">{{ request.form.anotacoes }}</textarea>
        </div>

        <button type="submit" class="btn btn-primary">Salvar e Ver Registros</button>
        <a href="{{ url_for('register') }}" class="btn btn-secondary">Voltar</a>
    </form>

    <hr>

    <h2>Registros Cadastrados</h2>

    <!-- Filter form for judiciary records - Limited to 3 fields as requested -->
    <form method="GET" action="{{ url_for('seeu') }}" class="mb-3">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="filter_infopen" class="form-label">Infopen</label>
                <input type="text" class="form-control" id="filter_infopen" name="filter_infopen" value="{{ filter_infopen or '' }}" placeholder="Filtrar por Infopen">
            </div>
            <div class="col-md-4 mb-3">
                <label for="filter_nome" class="form-label">Nome</label>
                <input type="text" class="form-control" id="filter_nome" name="filter_nome" value="{{ filter_nome or '' }}" placeholder="Filtrar por Nome">
            </div>
            <div class="col-md-4 mb-3">
                <label for="filter_numero_seeu" class="form-label">Número do SEEU</label>
                <input type="text" class="form-control" id="filter_numero_seeu" name="filter_numero_seeu" value="{{ filter_numero_seeu or '' }}" placeholder="Filtrar por Número SEEU">
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <button type="submit" class="btn btn-outline-primary">Filtrar Registros</button>
                <a href="{{ url_for('seeu') }}" class="btn btn-outline-secondary">Limpar Filtros</a>
            </div>
        </div>
    </form>

    <!-- Export button positioned in the upper right corner of the table -->
    <div class="d-flex justify-content-end mb-2">
        <a href="{{ url_for('export_seeu_csv',
            filter_infopen=filter_infopen or '',
            filter_nome=filter_nome or '',
            filter_numero_seeu=filter_numero_seeu or '') }}"
           class="btn btn-success">
            Exportar CSV
        </a>
    </div>

    {% if judiciary_records %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Infopen</th>
                        <th>Nome</th>
                        <th>Data da Notificação</th>
                        <th>Número do SEEU</th>
                        <th>Protocolo</th>
                        <th>Anotações</th>
                        <th>Data do Registro</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in judiciary_records %}
                    <tr>
                        <td>{{ record.infopen or '' }}</td>
                        <td>
                            {% set user = users | selectattr('infopen', 'equalto', record.infopen) | first %}
                            {{ user.nome_completo if user else '' }}
                        </td>
                        <td>{{ record.data_notificacao.strftime('%d/%m/%Y') if record.data_notificacao else '' }}</td>
                        <td>{{ record.numero_seeu or '' }}</td>
                        <td>{{ record.protocolo or '' }}</td>
                        <td>{{ record.anotacoes or '' | truncate(50, True) }}</td>
                        <td>{{ record.data_registro.strftime('%d/%m/%Y %H:%M:%S') if record.data_registro else '' }}</td>
                        <td>
                            <a href="{{ url_for('edit_seeu', record_id=record.id) }}" class="btn btn-sm btn-outline-primary me-1">Editar</a>
                            <form method="POST" action="{{ url_for('delete_seeu', record_id=record.id) }}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir este registro judicial?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-muted">Nenhum registro judicial encontrado.</p>
    {% endif %}
</div>
{% endblock %}